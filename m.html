<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…Ù† | Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .stat-value small {
            font-size: 14px;
            color: #94a3b8;
            font-weight: normal;
        }
        
        .tokens-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .token-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .token-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.1);
            border-color: #667eea;
        }
        
        .token-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .token-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }
        
        .token-info {
            flex: 1;
        }
        
        .token-symbol {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .token-name {
            color: #94a3b8;
            font-size: 13px;
        }
        
        .token-balance {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0 5px;
        }
        
        .token-value {
            color: #94a3b8;
            font-size: 14px;
        }
        
        .badge {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
        }
        
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
        
        .success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            color: #22c55e;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            margin-top: 30px;
        }
        
        .empty-state h3 {
            margin: 20px 0 10px;
            color: white;
        }
        
        .empty-state p {
            color: #94a3b8;
        }
        
        .network-badge {
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            color: #64748b;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">ğŸ” ØªÙˆÚ©Ù†â€ŒÛŒØ§Ø¨</div>
            <div id="wallet-btn"></div>
        </header>
        
        <div id="walletInfo" style="display: none;">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„</div>
                    <div class="stat-value" id="walletAddress">0x...</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Ø´Ø¨Ú©Ù‡</div>
                    <div class="stat-value" id="networkName">polygon</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</div>
                    <div class="stat-value" id="tokenCount">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Ø§Ø±Ø²Ø´ Ú©Ù„ (USD)</div>
                    <div class="stat-value" id="totalValue">$0</div>
                </div>
            </div>
            
            <div class="loading" id="loadingTokens">
                <div class="spinner"></div>
                <p>Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø§Ø² Moralis API...</p>
                <p style="font-size: 13px; color: #94a3b8; margin-top: 10px;">Ø§ÛŒÙ† ÙØ±Ø¢ÛŒÙ†Ø¯ Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø·ÙˆÙ„ Ù…ÛŒâ€ŒÚ©Ø´Ø¯</p>
            </div>
            
            <div id="error" class="error" style="display: none;"></div>
            
            <div id="tokensContainer">
                <div class="empty-state" id="emptyState">
                    <div style="font-size: 48px;">ğŸ‘›</div>
                    <h3>Ù‡Ù†ÙˆØ² Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª</h3>
                    <p>Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯</p>
                </div>
                
                <div class="tokens-grid" id="tokensGrid" style="display: none;"></div>
            </div>
        </div>
        
        <div id="tokenDetailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: #1e293b; border-radius: 24px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="modalTokenName" style="font-size: 24px;"></h2>
                    <button onclick="closeModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">âœ•</button>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; margin: 0 auto 15px;" id="modalTokenLogo">?</div>
                    <div style="font-size: 32px; font-weight: bold;" id="modalTokenBalance">0</div>
                    <div style="color: #94a3b8; margin-top: 5px;" id="modalTokenValue">$0</div>
                </div>
                
                <div style="background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #94a3b8;">Ø¢Ø¯Ø±Ø³ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯:</span>
                        <span style="font-family: monospace;" id="modalTokenAddress">0x...</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #94a3b8;">Ù†Ù…Ø§Ø¯:</span>
                        <span id="modalTokenSymbol">???</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #94a3b8;">Ø§Ø¹Ø´Ø§Ø±:</span>
                        <span id="modalTokenDecimals">18</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #94a3b8;">Ø´Ø¨Ú©Ù‡:</span>
                        <span id="modalTokenChain">polygon</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="copyToClipboard(this.dataset.address)" data-address="" id="modalCopyBtn" style="background: rgba(102, 126, 234, 0.2); color: #667eea; border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold;">ğŸ“‹ Ú©Ù¾ÛŒ Ø¢Ø¯Ø±Ø³</button>
                    <a href="#" id="modalExplorerLink" target="_blank" style="background: rgba(255,255,255,0.1); color: white; text-decoration: none; padding: 12px; border-radius: 12px; text-align: center; font-weight: bold;">ğŸ”— Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ø§Ú©Ø³Ù¾Ù„ÙˆØ±Ø±</a>
                </div>
            </div>
        </div>
        
        <footer>
            âš¡ Ù‚Ø¯Ø±Øª Ú¯Ø±ÙØªÙ‡ Ø§Ø² Moralis API | Ù†Ù…Ø§ÛŒØ´ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„
        </footer>
    </div>

    <script type="import">
        import { createWeb3Modal, defaultWagmiConfig } from "https://esm.sh/@web3modal/wagmi";
        import { polygon, polygonAmoy } from "https://esm.sh/wagmi/chains";
        import { getAccount, watchAccount } from "https://esm.sh/wagmi/actions";
        import { formatEther } from "https://esm.sh/viem";
        
        // ==================== Ú©Ø§Ù†ÙÛŒÚ¯ ====================
        const projectId = "96f13374b0fe2f629a925617de0a2ba3";
        const MORALIS_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6ImU1NzhjODg4LTMwNGYtNDVjYy1hOWYxLWU0OGEyMDNmNTcxNiIsIm9yZ0lkIjoiNTAxNzgxIiwidXNlcklkIjoiNTE2MzA2IiwidHlwZUlkIjoiNDEzNDQ2MzctYTBmMy00YWUyLTkwNjEtZjA0NjI3ZGUzZjVkIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NzE3MzYxMzcsImV4cCI6NDkyNzQ5NjEzN30.1DXMrflFDZngmc9e-IlWjlO7Pjxbg4URR6C9u3E3tXI';
        const MORALIS_BASE_URL = 'https://deep-index.moralis.io/api/v2.2';
        
        const metadata = {
            name: "Polygon Token Viewer",
            description: "Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„",
            url: window.location.href,
            icons: []
        };
        
        const chains = [polygon, polygonAmoy];
        const wagmiConfig = defaultWagmiConfig({ chains, projectId, metadata });
        
        // ==================== Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ ====================
        createWeb3Modal({ wagmiConfig, projectId, chains });
        
        // Ø¯Ú©Ù…Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„
        const btn = document.createElement("w3m-button");
        document.getElementById("wallet-btn").appendChild(btn);
        
        // ==================== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú¯Ù„ÙˆØ¨Ø§Ù„ ====================
        let currentAccount = null;
        let currentChain = 'polygon';
        
        // ==================== Ù…Ù¾ Ú©Ø±Ø¯Ù† Ù†Ø§Ù… Ø´Ø¨Ú©Ù‡ ====================
        const chainMap = {
            137: 'polygon',
            80002: 'polygon-amoy'
        };
        
        // ==================== watching account ====================
        watchAccount(wagmiConfig, {
            onChange(account) {
                console.log('Account changed:', account);
                if (account?.address) {
                    currentAccount = account.address;
                    document.getElementById('walletInfo').style.display = 'block';
                    document.getElementById('walletAddress').innerText = account.address;
                    document.getElementById('emptyState').style.display = 'none';
                    
                    // Ø¯Ø±ÛŒØ§ÙØª chainId
                    if (account.chainId) {
                        currentChain = chainMap[account.chainId] || 'polygon';
                        document.getElementById('networkName').innerText = currentChain;
                    }
                    
                    // Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§
                    fetchWalletTokens(account.address, currentChain);
                } else {
                    // Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù‚Ø·Ø¹ Ø´Ø¯
                    currentAccount = null;
                    document.getElementById('walletInfo').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    document.getElementById('tokensGrid').style.display = 'none';
                }
            }
        });
        
        // ==================== Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ ====================
        async function fetchWalletTokens(address, chain) {
            showLoading();
            
            try {
                // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø§Ø² Moralis
                const response = await fetch(`${MORALIS_BASE_URL}/${address}/erc20?chain=${chain}`, {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'X-API-Key': MORALIS_API_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª: ${response.status}`);
                }
                
                const tokens = await response.json();
                console.log('Tokens received:', tokens);
                
                if (tokens && tokens.length > 0) {
                    displayTokens(tokens, chain);
                    document.getElementById('tokenCount').innerText = tokens.length;
                } else {
                    showEmptyTokens();
                }
                
            } catch (error) {
                console.error('Error fetching tokens:', error);
                showError(error.message);
            } finally {
                hideLoading();
            }
        }
        
        // ==================== Ù†Ù…Ø§ÛŒØ´ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ ====================
        function displayTokens(tokens, chain) {
            const grid = document.getElementById('tokensGrid');
            grid.innerHTML = '';
            
            let totalValue = 0;
            
            for (const token of tokens) {
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                const balance = formatEther(BigInt(token.balance || '0'));
                const balanceNum = parseFloat(balance);
                
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø±Ø²Ø´ (Ø§Ú¯Ù‡ Ù‚ÛŒÙ…Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡)
                let value = 0;
                if (token.usd_price) {
                    value = balanceNum * parseFloat(token.usd_price);
                    totalValue += value;
                }
                
                const card = document.createElement('div');
                card.className = 'token-card';
                card.onclick = () => showTokenDetail(token, chain);
                
                card.innerHTML = `
                    <div class="token-header">
                        <div class="token-logo">${token.symbol?.charAt(0) || '?'}</div>
                        <div class="token-info">
                            <div class="token-symbol">${token.symbol || '???'}</div>
                            <div class="token-name">${token.name || 'Unknown'}</div>
                        </div>
                    </div>
                    <div class="token-balance">${balanceNum.toFixed(4)} ${token.symbol}</div>
                    <div class="token-value">â‰ˆ $${value.toFixed(2)}</div>
                    ${token.possible_spam ? '<div class="badge">âš ï¸ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ø§Ø³Ù¾Ù…</div>' : ''}
                `;
                
                grid.appendChild(card);
            }
            
            document.getElementById('totalValue').innerText = `$${totalValue.toFixed(2)}`;
            document.getElementById('emptyState').style.display = 'none';
            grid.style.display = 'grid';
        }
        
        // ==================== Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆÚ©Ù† ====================
        function showTokenDetail(token, chain) {
            const balance = formatEther(BigInt(token.balance || '0'));
            const balanceNum = parseFloat(balance);
            const value = token.usd_price ? (balanceNum * parseFloat(token.usd_price)).toFixed(2) : '0';
            
            document.getElementById('modalTokenName').innerText = `${token.name || 'Unknown'} (${token.symbol || '???'})`;
            document.getElementById('modalTokenLogo').innerText = token.symbol?.charAt(0) || '?';
            document.getElementById('modalTokenBalance').innerText = `${balanceNum.toFixed(6)} ${token.symbol}`;
            document.getElementById('modalTokenValue').innerText = `â‰ˆ $${value}`;
            document.getElementById('modalTokenAddress').innerText = token.token_address || token.address;
            document.getElementById('modalTokenSymbol').innerText = token.symbol || '???';
            document.getElementById('modalTokenDecimals').innerText = token.decimals || '18';
            document.getElementById('modalTokenChain').innerText = chain;
            
            const copyBtn = document.getElementById('modalCopyBtn');
            copyBtn.dataset.address = token.token_address || token.address;
            
            const explorerLink = document.getElementById('modalExplorerLink');
            if (chain === 'polygon') {
                explorerLink.href = `https://polygonscan.com/token/${token.token_address || token.address}`;
            } else {
                explorerLink.href = `https://amoy.polygonscan.com/token/${token.token_address || token.address}`;
            }
            
            document.getElementById('tokenDetailModal').style.display = 'flex';
        }
        
        // ==================== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
        function showLoading() {
            document.getElementById('loadingTokens').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('tokensGrid').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loadingTokens').style.display = 'none';
        }
        
        function showError(message) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerText = message;
            document.getElementById('tokensGrid').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('emptyState').innerHTML = `
                <div style="font-size: 48px;">âŒ</div>
                <h3>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h3>
                <p>${message}</p>
            `;
        }
        
        function showEmptyTokens() {
            document.getElementById('tokensGrid').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('emptyState').innerHTML = `
                <div style="font-size: 48px;">ğŸª™</div>
                <h3>Ù‡ÛŒÚ† ØªÙˆÚ©Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                <p>Ø§ÛŒÙ† Ú©ÛŒÙ Ù¾ÙˆÙ„ ØªÙˆÚ©Ù†ÛŒ Ø¯Ø± Ø´Ø¨Ú©Ù‡ Polygon Ù†Ø¯Ø§Ø±Ø¯</p>
            `;
        }
        
        window.closeModal = function() {
            document.getElementById('tokenDetailModal').style.display = 'none';
        };
        
        window.copyToClipboard = function(address) {
            navigator.clipboard.writeText(address).then(() => {
                alert('Ø¢Ø¯Ø±Ø³ Ú©Ù¾ÛŒ Ø´Ø¯!');
            });
        };
    </script>
</body>
  </html>
